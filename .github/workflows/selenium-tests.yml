name: Selenium Login & Register Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  selenium-test:
    runs-on: ubuntu-latest

    steps:
      # ================= CHECKOUT =================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ================= INSTALL SYSTEM DEPENDENCIES =================
      - name: Install PHP, MySQL, Chrome
        run: |
          sudo apt update
          sudo apt install -y \
            php php-cli php-mysql \
            mariadb-server mariadb-client \
            unzip curl \
            google-chrome-stable

      # ================= START DATABASE =================
      - name: Start MariaDB
        run: |
          sudo systemctl start mariadb
          sudo systemctl enable mariadb

      # ================= SETUP DATABASE =================
      - name: Setup Database
        run: |
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS quiz_pengupil;"
          sudo mysql -u root quiz_pengupil < db/quiz_pengupil.sql
          sudo mysql -u root -e "FLUSH PRIVILEGES;"

      - name: Verify Database
        run: |
          sudo mysql -u root -e "USE quiz_pengupil; SHOW TABLES;"

      # ================= CREATE INDEX.PHP =================
      - name: Create index.php
        run: |
          echo "<?php echo 'Server running'; ?>" > index.php

      # ================= START PHP SERVER =================
      - name: Start PHP Server
        run: |
          nohup php -S 127.0.0.1:8000 -t . > server.log 2>&1 &
          sleep 5
          cat server.log

      - name: Wait for Server
        run: |
          for i in {1..10}; do
            curl -s http://127.0.0.1:8000 && echo "✅ Server ready" && exit 0
            echo "⏳ Waiting for server..."
            sleep 2
          done
          echo "❌ Server failed"
          exit 1

      # ================= PYTHON =================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium pytest webdriver-manager chromedriver-autoinstaller requests

      # ================= RUN TEST =================
      - name: Run Selenium Tests
        run: python test.py

      # ================= UPLOAD ARTIFACT =================
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-results
          path: test-results/

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-logs
          path: test-results/test_log.txt
