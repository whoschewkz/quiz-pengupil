name: Selenium CI - Login & Register

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  selenium-test:
    runs-on: ubuntu-latest

    steps:
      # =========================
      # CHECKOUT CODE
      # =========================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # INSTALL SYSTEM DEPENDENCIES
      # =========================
      - name: Install PHP, Chrome, MySQL
        run: |
          sudo apt update
          sudo apt install -y \
            php php-cli php-mysql \
            mariadb-server mariadb-client \
            google-chrome-stable unzip curl

      # =========================
      # START DATABASE
      # =========================
      - name: Start MariaDB
        run: |
          sudo systemctl start mariadb
          sudo systemctl enable mariadb

      # =========================
      # SETUP DATABASE
      # =========================
      - name: Setup Database
        run: |
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS quiz_pengupil;"
          sudo mysql -u root quiz_pengupil < db/quiz_pengupil.sql
          sudo mysql -u root -e "FLUSH PRIVILEGES;"

      # =========================
      # START PHP SERVER (PORT 80)
      # =========================
      - name: Start PHP server on localhost
        run: |
          sudo php -S localhost:80 -t . > server.log 2>&1 &
          sleep 5
          echo "===== SERVER LOG ====="
          cat server.log

      # =========================
      # VERIFY SERVER
      # =========================
      - name: Verify Web Server
        run: |
          curl -I http://localhost/quiz-pengupil/login.php

      # =========================
      # SETUP PYTHON
      # =========================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # =========================
      # INSTALL PYTHON DEPS
      # =========================
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium pytest webdriver-manager

      # =========================
      # RUN SELENIUM TESTS
      # =========================
      - name: Run Selenium Login Tests
        run: pytest test_login.py

      - name: Run Selenium Register Tests
        run: pytest test_register.py
